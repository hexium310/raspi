services:
  prometheus:
    image: prom/prometheus:v3.5.0
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --web.enable-admin-api
    configs:
      - source: prometheus
        target: /etc/prometheus/prometheus.yml
    volumes:
      - type: volume
        source: prometheus
        target: /prometheus
    networks:
      - default
      - proxy
    deploy:
      labels:
        traefik.enable: "true"
        traefik.docker.network: proxy
        traefik.http.routers.prometheus.entrypoints: web
        traefik.http.routers.prometheus.rule: Host(`prometheus.raspi.internal`)
        traefik.http.services.prometheus.loadbalancer.server.port: "9090"

  node_exporter:
    image: prom/node-exporter:v1.9.1
    volumes:
      - type: bind
        source: /
        target: /rootfs
        read_only: true
      - type: bind
        source: /proc
        target: /host/proc
        read_only: true
      - type: bind
        source: /sys
        target: /host/sys
        read_only: true
      - type: bind
        source: /run
        target: /host/run
        read_only: true
    command:
      - --path.rootfs
      - /rootfs
      - --path.procfs
      - /host/proc
      - --path.sysfs
      - /host/sys
      - --path.udev.data
      - /host/run/udev/data
      - --no-collector.selinux
      - --collector.filesystem.mount-points-exclude
      - ^(/rootfs)?/(dev|host|proc|sys|var/lib/docker/.+)($$|/)
      - --collector.netdev.device-exclude
      - ^(br|veth|docker)
    networks:
      - default
      - proxy
    deploy:
      mode: global
      labels:
        traefik.enable: "true"
        traefik.docker.network: proxy
        traefik.http.routers.node_exporter.entrypoints: web
        traefik.http.routers.node_exporter.rule: Host(`node-exporter.raspi.internal`)
        traefik.http.services.node_exporter.loadbalancer.server.port: "9100"

  cadvisor:
    image: ghcr.io/google/cadvisor:v0.53.0
    volumes:
      - type: bind
        source: /
        target: /rootfs
        read_only: true
      - type: bind
        source: /var/run
        target: /var/run
        read_only: true
      - type: bind
        source: /sys
        target: /sys
        read_only: true
      - type: bind
        source: /var/lib/docker/
        target: /var/lib/docker
        read_only: true
      - type: bind
        source: /dev/disk/
        target: /dev/disk
        read_only: true

  grafana:
    image: grafana/grafana:12.1.0
    volumes:
      - type: volume
        source: grafana
        target: /var/lib/grafana
    networks:
      - default
      - proxy
    deploy:
      labels:
        traefik.enable: "true"
        traefik.docker.network: proxy
        traefik.http.routers.grafana.entrypoints: web
        traefik.http.routers.grafana.rule: Host(`grafana.raspi.internal`)
        traefik.http.services.grafana.loadbalancer.server.port: "3000"

configs:
  prometheus:
    file: ./prometheus/prometheus.yml

volumes:
  grafana: 
    driver: local
  prometheus:
    driver: local

networks:
  proxy:
    external: true
