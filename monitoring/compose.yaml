services:
  prometheus:
    image: prom/prometheus:v3.5.0
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --web.enable-admin-api
    configs:
      - source: prometheus
        target: /etc/prometheus/prometheus.yml
    volumes:
      - type: volume
        source: prometheus
        target: /prometheus
    extra_hosts:
      host.docker.internal: host-gateway
    networks:
      - default
      - proxy
    deploy:
      labels:
        traefik.enable: "true"
        traefik.docker.network: proxy
        traefik.http.routers.prometheus.entrypoints: web
        traefik.http.routers.prometheus.rule: Host(`prometheus.raspi.internal`)
        traefik.http.services.prometheus.loadbalancer.server.port: "9090"

  cadvisor:
    image: ghcr.io/google/cadvisor:v0.53.0
    volumes:
      - type: bind
        source: /
        target: /rootfs
        read_only: true
      - type: bind
        source: /var/run
        target: /var/run
        read_only: true
      - type: bind
        source: /sys
        target: /sys
        read_only: true
      - type: bind
        source: /var/lib/docker/
        target: /var/lib/docker
        read_only: true
      - type: bind
        source: /dev/disk/
        target: /dev/disk
        read_only: true

  snmp_exporter:
    image: prom/snmp-exporter

  grafana:
    image: grafana/grafana:12.1.0
    volumes:
      - type: volume
        source: grafana
        target: /var/lib/grafana
    networks:
      - default
      - proxy
    deploy:
      labels:
        traefik.enable: "true"
        traefik.docker.network: proxy
        traefik.http.routers.grafana.entrypoints: web
        traefik.http.routers.grafana.rule: Host(`grafana.raspi.internal`)
        traefik.http.services.grafana.loadbalancer.server.port: "3000"

configs:
  prometheus:
    file: ./prometheus/prometheus.yml

volumes:
  grafana:
    driver: local
  prometheus:
    driver: local

networks:
  proxy:
    external: true
